{% extends 'base.html.twig' %}

{% block title %}Dashboard - {{ parent() }}{% endblock %}

{% block body %}
<div class="dashboard-container">
    <!-- Bandeau de capacité (mobile/tablette uniquement) -->
    <div class="capacity-banner d-lg-none">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="capacity-indicators">
                        <!-- Total SP -->
                        <div class="capacity-item">
                            <i class="bi bi-funnel capacity-icon"></i>
                            <span class="capacity-label">Total</span>
                            <span class="capacity-value">{{ total_sp ?? 320 }}</span>
                        </div>
                        
                        <!-- Capacité -->
                        <div class="capacity-item">
                            <span class="capacity-label">Capacité</span>
                            <span class="capacity-value capacity-highlight">{{ capacity ?? 255 }}</span>
                        </div>
                        
                        <!-- Delta -->
                        <div class="capacity-item">
                            <span class="capacity-label">Delta</span>
                            <span class="capacity-value capacity-negative">{{ delta ?? -70 }}</span>
                        </div>
                        
                        <!-- Jauge de capacité -->
                        <div class="capacity-gauge">
                            <div class="progress">
                                <div class="progress-bar bg-danger" role="progressbar" 
                                     style="width: {{ ((capacity ?? 255) / (total_sp ?? 320) * 100) }}%" 
                                     aria-valuenow="{{ capacity ?? 255 }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="{{ total_sp ?? 320 }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-light btn-sync">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        <span class="d-none d-sm-inline">Simulate</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tableau des User Stories -->
    <div class="stories-table-container">
        <div class="table-responsive">
            <table class="table table-hover stories-table">
                <thead>
                    <tr>
                        <th scope="col" class="col-num">#</th>
                        <th scope="col" class="col-title">Title</th>
                        <th scope="col" class="col-est">Est.</th>
                        <th scope="col" class="col-dev">Dev</th>
                        <th scope="col" class="col-team">Team</th>
                        <th scope="col" class="col-source">Source</th>
                        <th scope="col" class="col-progression">Progression</th>
                        <th scope="col" class="col-status">Status</th>
                        <th scope="col" class="col-actions"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items ?? sample_items %}
                    <tr class="story-row" data-story-id="{{ item.id }}" data-bs-toggle="tooltip" title="Cliquer pour voir les détails">
                        <td class="story-number">{{ item.number ?? loop.index }}</td>
                        <td class="story-title">
                            <div class="title-content">
                                {{ item.title }}
                            </div>
                        </td>
                        <td class="story-estimate">
                            {% if item.estimate_sp is not null %}
                                <span class="estimate-value">{{ item.estimate_sp }}</span>
                                <span class="estimate-unit">SP</span>
                            {% else %}
                                <span class="estimate-empty">—</span>
                            {% endif %}
                        </td>
                        <td class="story-dev">
                            {{ item.dev }}
                        </td>
                        <td class="story-team">
                            {% set team_colors = {
                                'console': '#17a2b8',
                                'core': '#28a745',
                                'extend': '#ffc107',
                                'e-invoice': '#6f42c1'
                            } %}
                            <span class="team-badge" style="background-color: {{ team_colors[item.team] ?? '#6c757d' }}">
                                {{ item.team }}
                            </span>
                        </td>
                        <td class="story-source">
                            <div class="source-container">
                                {% if item.source == 'jira' %}
                                    <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/jira/jira-original.svg" 
                                         alt="Jira" 
                                         class="source-logo" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span class="source-fallback" style="display:none;">Jira</span>
                                {% elseif item.source == 'ado' %}
                                    <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/azure/azure-original.svg" 
                                         alt="Azure DevOps" 
                                         class="source-logo" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span class="source-fallback" style="display:none;">AZDO</span>
                                {% else %}
                                    <span class="source-fallback">{{ item.source|upper }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="story-progression">
                            <div class="progression-container">
                                <div class="progression-bar">
                                    <div class="progression-fill" style="width: {{ item.progression ?? 0 }}%"></div>
                                </div>
                                <span class="progression-text">{{ item.progression ?? 0 }}%</span>
                            </div>
                        </td>
                        <td class="story-status">
                            {% set status_classes = {
                                'Ready to develop': 'ready',
                                'Ready to R&D': 'research',
                                'In development': 'in-progress',
                                'Done': 'done'
                            } %}
                            <span class="status-badge status-{{ status_classes[item.status] ?? 'ready' }}">
                                {{ item.status }}
                            </span>
                        </td>
                        <td class="story-actions">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-secondary" title="Éditer">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" title="Plus d'options">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Version mobile : Liste des cartes -->
    <div class="stories-mobile d-md-none">
        {% for item in items ?? sample_items %}
        <div class="story-card" data-story-id="{{ item.id }}">
            <div class="story-card-header">
                <div class="story-card-title">
                    <span class="story-number">#{{ item.number ?? loop.index }}</span>
                    <span class="story-title">{{ item.title }}</span>
                </div>
                <div class="story-card-estimate">
                    {% if item.estimate_sp is not null %}
                        <span class="estimate-value">{{ item.estimate_sp }}</span>
                        <span class="estimate-unit">SP</span>
                    {% else %}
                        <span class="estimate-empty">—</span>
                    {% endif %}
                </div>
            </div>
            <div class="story-card-body">
                <div class="story-card-meta">
                {% set team_colors = {
                    'console': '#17a2b8',
                    'core': '#28a745',
                    'extend': '#ffc107',
                    'e-invoice': '#6f42c1'
                } %}
                <span class="team-badge" style="background-color: {{ team_colors[item.team] ?? '#6c757d' }}">
                    {{ item.team }}
                </span>
                
                <div class="source-mobile">
                    {% if item.source == 'jira' %}
                        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/jira/jira-original.svg" 
                             alt="Jira" 
                             class="source-logo-mobile" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span class="source-fallback-mobile" style="display:none;">Jira</span>
                    {% elseif item.source == 'ado' %}
                        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/azure/azure-original.svg" 
                             alt="Azure DevOps" 
                             class="source-logo-mobile" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span class="source-fallback-mobile" style="display:none;">AZDO</span>
                    {% else %}
                        <span class="source-fallback-mobile">{{ item.source|upper }}</span>
                    {% endif %}
                </div>
                
                {% set status_classes = {
                    'Ready to develop': 'ready',
                    'Ready to R&D': 'research',
                    'In development': 'in-progress',
                    'Done': 'done'
                } %}
                <span class="status-badge status-{{ status_classes[item.status] ?? 'ready' }}">
                    {{ item.status }}
                </span>
                <div class="progression-mobile">
                    <span class="progression-text">{{ item.progression ?? 0 }}%</span>
                </div>
            </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
